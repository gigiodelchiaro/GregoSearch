import{i as F,r as J,t as r}from"./i18n-B09WZxBh.js";document.addEventListener("DOMContentLoaded",async()=>{await F(),x(),J(x);let g=null;const L=document.getElementById("chant-incipit"),I=document.getElementById("chant-metadata"),d=document.getElementById("chant-score"),k=document.getElementById("gabc-source-hidden"),C=document.querySelector("title"),U=document.getElementById("gregobase-link"),A=document.getElementById("neumz-link"),E=document.getElementById("summit-link"),_=document.getElementById("illuminare-link"),H=document.getElementById("benedictus-link"),B=document.getElementById("download-svg-btn"),G=document.getElementById("download-gabc-btn"),b=document.getElementById("copy-gabc-btn"),S=document.getElementById("clean"),T=document.getElementById("remove"),$=document.getElementById("line"),h=document.getElementById("render"),N=new RegExp("'\\d?|_|\\[.+\\]|\\.(?<!\\([^(])(?=[^(]*?\\))\\d?","gm"),j=/<i>i+j.<\/i>|\*|<[^>]*>|~|\{|\}/gm,q={al:"Alleluia",an:"Antiphona",ca:"Canticum",co:"Communio",gr:"Graduale",hy:"Hymnus",im:"Improperia",in:"Introitus",ky:"Kyriale",of:"Offertorium",or:"Toni Communes",pa:"Prosa",pr:"Praefationes",ps:"Psalmus",rb:"Responsorium breve",re:"Responsorium",rh:"Rhythmus",se:"Sequentia",su:"Supplicatio",tp:"Tropa",tr:"Tractus",va:"Varia"};function M(e){if(!e)return"";const t=[],n=(e.incipit||"").replace(";",":");return n&&t.push(`name:${n};`),e["office-part"]&&t.push(`office-part:${e["office-part"]};`),e.mode&&t.push(`mode:${e.mode};`),e.transcriber&&t.push(`transcriber:${e.transcriber};`),t.join(`
`)+`
%%
`}function R(e){if(!e||!e.gabc)return"";try{const t=JSON.parse(e.gabc);if(Array.isArray(t)){const n=t.find(o=>Array.isArray(o)&&o[0]==="gabc");return n?n[1].trim():""}return typeof t=="string"?t.trim():""}catch(t){return typeof e.gabc=="string"?e.gabc.trim():(console.error("Could not extract GABC score:",t),"")}}function f(e){if(!e)return"";let t=e;S.checked&&(t=t.replace(N,"")),T.checked&&(t=t.replace(j,"")),$.checked&&(t=t.replaceAll("::","::Z"));const n=/^((?:[^A-Z]|\([^)]*\))*)([A-Z][^,:\s]*)/;return t.replace(n,(o,a)=>{const i=a.charAt(0)+a.substring(1).toLowerCase();return o+i})}async function z(){const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"),10);if(isNaN(t)){v(r("invalid_id"));return}try{const n=await fetch("/data/chants.json");if(!n.ok)throw new Error(r("load_database_error"));const a=(await n.json()).find(i=>i.id===t);if(!a){v(r("chant_not_found",{chantId:t}));return}g=a,x(),V(a),D(a),w()}catch(n){v(r("load_info_error")),console.error(n)}}function w(){g&&(h.checked?P(g):O(g))}function O(e){d.innerHTML=`<img src="https://gregobase.selapa.net/chant_img.php?id=${e.id}" alt="${r("chant_image_alt",{incipit:e.incipit})}">`}function P(e){const t=R(e),n=f(t);if(!n||!window.exsurge){d.innerHTML=`<p class="no-results-message">${r("score_unavailable_exsurge_error")}</p>`;return}try{d.innerHTML=`<p class="loading-message">${r("rendering_score")}</p>`,k.value=n;const o=new window.exsurge.ChantContext,a=window.exsurge.Gabc.createMappingsFromSource(o,k.value),i=new window.exsurge.ChantScore(o,a,!0);i.performLayoutAsync(o,()=>{i.layoutChantLines(o,d.clientWidth,()=>{d.innerHTML=i.createSvg(o)})})}catch(o){d.innerHTML=`<p class="no-results-message">${r("render_gabc_error")}</p>`,console.error("GABC rendering error:",o)}}function V(e){C.textContent=e.incipit,L.textContent=e.incipit;const t={[r("mode")]:W(e.mode),[r("office_part")]:q[e["office-part"]]||"N/A",[r("version")]:e.version,[r("transcriber")]:e.transcriber||"N/A",[r("commentary")]:e.commentary||"None"};let n=`<h2>${r("details")}</h2><dl class="metadata-list">`;for(const[o,a]of Object.entries(t))a&&a!=="N/A"&&a!=="None"&&(n+=`<li><dt>${o}</dt><dd>${a}</dd></li>`);n+="</dl>",I.innerHTML=n}function D(e){const t=e.id,n=e.incipit||"chant",o=R(e);U.href=`https://gregobase.selapa.net/chant.php?id=${t}`,B.style.display="block";const a=()=>{const c=f(o),s=encodeURIComponent(c);A.href=`https://scrib.io/#q=${s}`,E.href=`https://editor.sourceandsummit.com/alpha/#annotation%3A%20%0A%25%25%0A${s}`,_.href=`https://editor.sourceandsummit.com/legacy/#annotation%3A%20%0A%25%25%0A${s}`,H.href=`https://benedictus.liturgiacantada.com.br/#gabc=%0A%25%25%0A${s}`},i=()=>{a(),w()};if(o){a(),S.addEventListener("change",i),T.addEventListener("change",i),$.addEventListener("change",i),A.style.display="inline-block",E.style.display="inline-block",_.style.display="inline-block",b.style.display="inline-block",G.style.display="inline-block";const c=document.querySelector('label[for="clean"]');c&&(c.style.display="flex");const s=document.querySelector('label[for="remove"]');s&&(s.style.display="flex");const p=document.querySelector('label[for="line"]');p&&(p.style.display="flex")}G.addEventListener("click",()=>{const c=f(o),s=M(e)+c,p=new Blob([s],{type:"text/plain;charset=utf-8"}),m=URL.createObjectURL(p),l=document.createElement("a");l.href=m,l.download=`${n.replace(/[^a-z0-9]/gi,"_")}.gabc`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(m)}),b.addEventListener("click",()=>{const c=f(o),s=M(e)+c;Z(s,b,r("copied"))}),B.addEventListener("click",async()=>{let c="",s=`${n.replace(/[^a-z0-9]/gi,"_")}.svg`;if(h.checked){const y=d.querySelector("svg");if(!y){alert(r("no_svg_to_download"));return}c=new XMLSerializer().serializeToString(y),c.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)||(c=c.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),c.match(/^<svg[^>]+xmlns:xlink="http:\/\/www\.w3\.org\/1999\/xlink"/)||(c=c.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"'))}else{const y=`https://gregobase.selapa.net/chant_img.php?id=${t}`;try{const u=await fetch(y);if(!u.ok)throw new Error(r("fetch_svg_error"));c=await u.text()}catch(u){alert(r("download_svg_error",{message:u.message})),console.error(r("download_svg_error",{message:u.message}),u);return}}const p=new Blob([c],{type:"image/svg+xml;charset=utf-8"}),m=URL.createObjectURL(p),l=document.createElement("a");l.href=m,l.download=s,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(m)})}function W(e){return typeof e=="string"&&(e=parseInt(e,10)),isNaN(e)||e<1||e>8?String(e):["I","II","III","IV","V","VI","VII","VIII"][e-1]}async function Z(e,t,n){const o=t.textContent;t.textContent=n;try{await navigator.clipboard.writeText(e)}catch(a){console.error("Failed to copy text: ",a),t.textContent=r("copy_error")}setTimeout(()=>{t.textContent=o},2e3)}function v(e){C.textContent=r("error"),L.textContent=r("error"),I.innerHTML="",d.innerHTML=`<p class="no-results-message">${e}</p>`}function x(){document.querySelectorAll("[data-t]").forEach(e=>{const t=e.dataset.t;e.textContent=r(t)})}h.addEventListener("change",w),z()});
